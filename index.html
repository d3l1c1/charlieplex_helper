<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Charlieplex Wiring Helper</title>
<style>
:root{
  --bg:#0b0f14;--card:#121821;--muted:#a6b6c7;--accent:#66e0c2;--accent-2:#79a8ff;
  --text:#e9f1f7;--warn:#ffb86b;--bad:#ff6b6b;--ok:#66e08d;--border:#1f2834;
}
*{box-sizing:border-box}
body{
  margin:0;background:linear-gradient(180deg,#0b0f14,#0f1722 40%,#0b0f14);
  color:var(--text);font:19px/1.65 system-ui,Segoe UI,Roboto,Inter,Arial;
}
.wrap{max-width:1000px;margin:28px auto;padding:0 16px}
h1{font-size:30px;margin:0 0 10px}
p.lead{color:var(--muted);margin:0 0 20px;font-size:18px}
.cards{display:flex;flex-direction:column;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.card h2{font-size:22px;margin:0;padding:14px 16px;border-bottom:1px solid var(--border);color:#eaf4ff}
.card .body{padding:16px}
label{color:var(--muted)}
.row{display:grid;grid-template-columns:1fr;gap:10px;margin:10px 0}
input[type="number"],input[type="text"],textarea,select{
  width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--border);
  background:#0f1520;color:var(--text);outline:none;font-size:19px;
}
textarea{min-height:180px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.btnrow{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
button{
  border:1px solid var(--border);background:#0f1a28;color:var(--text);
  padding:12px 18px;border-radius:12px;cursor:pointer;transition:.15s transform,.15s opacity;
  font-size:18px;font-weight:600;
}
button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071218;border:none}
button.ghost{background:transparent}
button:disabled{opacity:.55;cursor:not-allowed}
.hint{color:var(--muted);font-size:14px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0e1622;border:1px solid var(--border);font-size:16px}
.pairs{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:8px}
.pair{padding:10px 12px;border:1px dashed var(--border);border-radius:10px;background:#0e1622;font-size:18px;font-weight:600}
.pair.used{opacity:.5;background:#0b111a}
.list{max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px;background:#0e1622}
.list div{padding:7px 8px;border-bottom:1px dashed #162233}
.list div:last-child{border-bottom:0}
.inline{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:14px}
.tag.ok{color:var(--ok);border-color:#234b33}
.tag.bad{color:var(--bad);border-color:#4b2323}
.sep{height:1px;background:#1f2834;margin:12px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Charlieplex Wiring Helper</h1>
  <p class="lead">Default segments for jacket wiring are preloaded (NECK, SHOULDERS, CHESTS).</p>

  <div class="cards">
    <!-- Setup -->
    <div class="card"><h2>1) Setup</h2><div class="body">
      <div class="row">
        <label for="numLeds">Number of LEDs to wire</label>
        <input id="numLeds" type="number" min="1" value="20">
      </div>
      <div class="row">
        <label for="pins">Arduino pins (comma-separated)</label>
        <input id="pins" type="text" value="2,3,4,5,6,7">
        <div class="inline">
          <span id="capacityTag" class="tag">Capacity: —</span>
          <span class="hint">Max routable LEDs with N pins = <span class="mono">N × (N − 1)</span></span>
          <button id="recalc" class="ghost">Recalculate</button>
        </div>
      </div>
      <div class="btnrow">
        <button id="start" class="primary">Start Wizard</button>
        <button id="clearAll" class="ghost">Reset</button>
      </div>
    </div></div>

    <!-- Segments -->
    <div class="card"><h2>2) Segments</h2><div class="body">
      <div class="row">
        <label>Add new segment</label>
        <div class="inline">
          <input id="segName" type="text" placeholder="Name (e.g. ARM)">
          <select id="segParent"></select>
          <button id="addSeg" class="primary">Add</button>
        </div>
      </div>
      <div class="hint">Defaults: NECK_L→SHOULDER_L→CHEST_L and NECK_R→SHOULDER_R→CHEST_R. Roots start right after the HEART.</div>
      <div id="segList" class="list" style="margin-top:10px"></div>
    </div></div>

    <!-- All pairs -->
    <div class="card"><h2>3) All Pairs</h2><div class="body">
      <div class="hint">Format: <span class="mono">(hiPin,loPin) – (+,−)</span></div>
      <div id="pairContainer" class="pairs"></div>
    </div></div>

    <!-- Wizard -->
    <div class="card"><h2>4) Wiring Wizard</h2><div class="body">
      <div class="inline">
        <div class="pill"><b>Status:</b> <span id="statusText">Not started</span></div>
        <div class="pill"><b>LEDs:</b> <span id="wiredCount">0</span>/<span id="targetCount">0</span></div>
        <div class="pill"><b>Capacity:</b> <span id="capNow">0</span></div>
        <div class="pill"><b>Remaining:</b> <span id="remain">0</span></div>
        <div class="pill"><b>Segment:</b> <span id="currentSegLabel">—</span></div>
      </div>

      <div id="wizardPanel" style="margin-top:14px;display:none">
        <div class="inline">
          <div class="pill"><b>Pair:</b> <span id="suggestPair">—</span></div>
          <div class="pill"><b>LED index:</b> <span id="ledIndex">—</span></div>
          <label class="inline" style="margin-left:auto"><input type="checkbox" id="isHeart"> Mark as HEART</label>
        </div>

        <div class="btnrow">
          <button id="accept" class="primary">Accept</button>
          <button id="pickOther">Pick other</button>
          <button id="undo" class="ghost">Undo</button>
          <button id="finish" class="ghost">Finish</button>
        </div>

        <div id="picker" style="display:none;margin-top:10px">
          <select id="pairSelect"></select>
          <div class="btnrow">
            <button id="useSelected" class="primary">Use</button>
            <button id="cancelPick" class="ghost">Cancel</button>
          </div>
        </div>

        <div class="sep"></div>
        <div class="inline">
          <label for="setCurrentSeg">Change current segment:</label>
          <select id="setCurrentSeg"></select>
          <button id="useSeg" class="ghost">Use</button>
        </div>
        <div class="inline">
          <label for="segDir"><b>Segment direction:</b></label>
          <select id="segDir">
            <option value="from">From HEART → out</option>
            <option value="to">Towards HEART ←</option>
          </select>
          <button id="applySegDir" class="ghost">Apply</button>
        </div>

        <div id="log" class="list" style="margin-top:10px"></div>
      </div>
    </div></div>

    <!-- Export -->
    <div class="card"><h2>5) Export</h2><div class="body">
      <textarea id="codeOut" readonly placeholder="// Arduino arrays will appear here"></textarea>
      <div class="btnrow">
        <button id="exportCode" class="primary">Generate</button>
        <button id="copyCode">Copy</button>
      </div>
      <div class="hint">Paste the arrays into your branching sketch (PINS, LED_MAP, HEART, segments, enum, CHILDREN, SEGMENTS, ROOTS).</div>
    </div></div>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);

  // --- State ---
  let pins=[], orderedPairs=[], chosen=[], segments=[], currentSegId=null;
  let capacity=0, target=0;

  // Preload defaults (NECK/SHOULDER/CHEST)
  function loadDefaults(){
    segments=[
      {id:1,name:"NECK_L",parentId:null,children:[2],leds:[],fromHeart:true},
      {id:2,name:"SHOULDER_L",parentId:1,children:[3],leds:[],fromHeart:true},
      {id:3,name:"CHEST_L",parentId:2,children:[],leds:[],fromHeart:true},
      {id:4,name:"NECK_R",parentId:null,children:[5],leds:[],fromHeart:true},
      {id:5,name:"SHOULDER_R",parentId:4,children:[6],leds:[],fromHeart:true},
      {id:6,name:"CHEST_R",parentId:5,children:[],leds:[],fromHeart:true}
    ];
    currentSegId = 1;
  }
  loadDefaults();

  // --- Elements ---
  const numLeds=$('#numLeds'), pinsInput=$('#pins'), recalc=$('#recalc'), capacityTag=$('#capacityTag');
  const startBtn=$('#start'), clrBtn=$('#clearAll');

  const segName=$('#segName'), segParent=$('#segParent'), addSeg=$('#addSeg'), segList=$('#segList');

  const pairContainer=$('#pairContainer');

  const statusText=$('#statusText'), wiredCount=$('#wiredCount'), targetCount=$('#targetCount'), capNow=$('#capNow'), remain=$('#remain');
  const wizardPanel=$('#wizardPanel'), suggestPair=$('#suggestPair'), ledIndex=$('#ledIndex'), isHeart=$('#isHeart');
  const acceptBtn=$('#accept'), pickOtherBtn=$('#pickOther'), undoBtn=$('#undo'), finishBtn=$('#finish');
  const picker=$('#picker'), pairSelect=$('#pairSelect'), useSelected=$('#useSelected'), cancelPick=$('#cancelPick');

  const currentSegLabel=$('#currentSegLabel'), setCurrentSeg=$('#setCurrentSeg'), useSeg=$('#useSeg');
  const segDir=$('#segDir'), applySegDir=$('#applySegDir');

  const logDiv=$('#log');
  const exportCode=$('#exportCode'), copyCode=$('#copyCode'), codeOut=$('#codeOut');

  // --- Capacity helpers ---
  function parsePins(){
    return pinsInput.value.split(',').map(s=>parseInt(s.trim(),10)).filter(x=>!isNaN(x));
  }
  function updateCapacityTag(){
    const p = parsePins();
    const cap = p.length * (p.length - 1);
    capacity = cap;
    capacityTag.textContent = `Capacity with ${p.length} pins: ${cap}`;
    capacityTag.className = 'tag ' + ((parseInt(numLeds.value,10)||0) <= cap ? 'ok' : 'bad');
  }
  recalc.onclick = updateCapacityTag;
  pinsInput.addEventListener('input', updateCapacityTag);
  numLeds.addEventListener('input', updateCapacityTag);
  updateCapacityTag();

  // --- Segments UI ---
  function renderSegList(){
    segList.innerHTML='';
    segments.forEach(s=>{
      const parent = s.parentId ? (segments.find(x=>x.id===s.parentId)?.name) : '—';
      const dir = s.fromHeart ? 'HEART → out' : '← towards HEART';
      const row=document.createElement('div');
      row.innerHTML = `<b>${s.name}</b>  |  Parent: ${parent}  |  Dir: ${dir}  |  LEDs: [${s.leds.join(', ')}]`;
      segList.appendChild(row);
    });
    segParent.innerHTML = '<option value="">(no parent)</option>' +
      segments.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    setCurrentSeg.innerHTML = segments.map(s=>`<option value="${s.id}" ${s.id===currentSegId?'selected':''}>${s.name}</option>`).join('');
    currentSegLabel.textContent = segments.find(x=>x.id===currentSegId)?.name || '—';
  }
  renderSegList();

  // --- Pairs ---
  function buildPairs(){
    orderedPairs=[];
    for(let i=0;i<pins.length;i++){
      for(let j=0;j<pins.length;j++){
        if(i===j) continue;
        orderedPairs.push({hiIdx:i,loIdx:j,label:`(${i},${j}) – (+,−)`,used:false});
      }
    }
    renderPairs();
  }
  function renderPairs(){
    pairContainer.innerHTML = orderedPairs.map(p=>`<div class="pair${p.used?' used':''}">${p.label}</div>`).join('');
  }

  function appendLog(msg){
    const d=document.createElement('div'); d.textContent=msg;
    logDiv.appendChild(d); logDiv.scrollTop=logDiv.scrollHeight;
  }

  // --- Start / Reset ---
  startBtn.onclick=()=>{
    pins = parsePins();
    if(pins.length<2){ alert('Enter at least two pins.'); return; }
    target = parseInt(numLeds.value,10)||0;
    const maxLed = pins.length * (pins.length - 1);
    if(target <= 0){ alert('Enter a valid LED count.'); return; }
    if(target > maxLed){
      alert(`Too many LEDs for ${pins.length} pins.\nMax routable = ${maxLed} (N×(N−1)).`);
      return;
    }
    buildPairs();
    chosen=[];
    statusText.textContent='In progress';
    targetCount.textContent = String(target);
    capNow.textContent = String(maxLed);
    remain.textContent = String(maxLed - chosen.length);
    wizardPanel.style.display='block';
    renderSegList();
    suggestNext();
  };

  clrBtn.onclick=()=>{ location.reload(); };

  // --- Add Segment ---
  addSeg.onclick=()=>{
    const name=(segName.value||'').trim();
    if(!name){ alert('Enter a segment name.'); return; }
    if(segments.some(s=>s.name.toLowerCase()===name.toLowerCase())){ alert('Name already exists.'); return; }
    const parentVal = segParent.value;
    const id = segments.length ? Math.max(...segments.map(s=>s.id))+1 : 1;
    const parentId = parentVal ? parseInt(parentVal,10) : null;
    const seg={id,name,parentId,children:[],leds:[],fromHeart:true};
    segments.push(seg);
    if(parentId){ const p=segments.find(s=>s.id===parentId); p.children.push(id); }
    if(!currentSegId) currentSegId=id;
    segName.value='';
    renderSegList();
  };

  useSeg.onclick=()=>{
    const v=setCurrentSeg.value;
    if(!v) return;
    currentSegId=parseInt(v,10);
    renderSegList();
  };

  applySegDir.onclick=()=>{
    if(!currentSegId){ alert('Select a segment first.'); return; }
    const s=segments.find(x=>x.id===currentSegId);
    s.fromHeart = (segDir.value==='from');
    renderSegList();
  };

  // --- Wizard flow ---
  function suggestNext(){
    const p = orderedPairs.find(p=>!p.used);
    suggestPair.textContent = p ? p.label : 'No unused pairs left.';
    ledIndex.textContent = String(chosen.length);
  }

  function markUsed(h,l,u){ const it=orderedPairs.find(p=>p.hiIdx===h&&p.loIdx===l); if(it){ it.used=u; renderPairs(); } }

  function addChoice(h,l,heart){
    // capacity guard
    const maxLed = pins.length * (pins.length - 1);
    if(chosen.length >= maxLed){
      alert('You reached the maximum routable LEDs for your pin count.');
      return;
    }
    const idx=chosen.length;
    chosen.push(heart?{hiIdx:h,loIdx:l,kind:'HEART'}:{hiIdx:h,loIdx:l,kind:'SEG',segId:currentSegId});
    if(!heart){
      const s=segments.find(x=>x.id===currentSegId);
      if(s) s.leds.push(idx);
    }
    markUsed(h,l,true);
    appendLog(`LED ${idx}: (${h},${l}) – (+,−)  [${heart?'HEART':(segments.find(x=>x.id===currentSegId)?.name||'?')}]`);
    wiredCount.textContent=String(chosen.length);
    remain.textContent = String(maxLed - chosen.length);
    suggestNext();

    // stop auto-wiring if target reached
    if(chosen.length >= target){
      statusText.textContent = 'Target reached';
    }
  }

  acceptBtn.onclick=()=>{
    const maxLed = pins.length*(pins.length-1);
    if(chosen.length >= maxLed){ alert('Capacity reached for current pins.'); return; }
    const p=orderedPairs.find(p=>!p.used);
    if(!p){ alert('No unused pairs left.'); return; }
    if(!isHeart.checked && !currentSegId){ alert('Choose a segment or mark as HEART.'); return; }
    addChoice(p.hiIdx,p.loIdx,isHeart.checked);
    isHeart.checked=false;
  };

  pickOtherBtn.onclick=()=>{
    const maxLed = pins.length*(pins.length-1);
    if(chosen.length >= maxLed){ alert('Capacity reached for current pins.'); return; }
    picker.style.display='block';
    pairSelect.innerHTML = orderedPairs.filter(p=>!p.used).map(p=>`<option value="${p.hiIdx},${p.loIdx}">${p.label}</option>`).join('');
  };
  cancelPick.onclick=()=>{ picker.style.display='none'; };

  useSelected.onclick=()=>{
    const maxLed = pins.length*(pins.length-1);
    if(chosen.length >= maxLed){ alert('Capacity reached for current pins.'); picker.style.display='none'; return; }
    const val=pairSelect.value; if(!val) return;
    const [h,l]=val.split(',').map(x=>parseInt(x,10));
    if(!isHeart.checked && !currentSegId){ alert('Choose a segment or mark as HEART.'); return; }
    addChoice(h,l,isHeart.checked);
    isHeart.checked=false;
    picker.style.display='none';
  };

  undoBtn.onclick=()=>{
    if(!chosen.length) return;
    const last = chosen.pop();
    markUsed(last.hiIdx,last.loIdx,false);
    if(last.kind==='SEG'){
      const s=segments.find(x=>x.id===last.segId);
      if(s) s.leds = s.leds.filter(i=>i!==chosen.length);
    }
    wiredCount.textContent=String(chosen.length);
    const maxLed = pins.length*(pins.length-1);
    remain.textContent = String(maxLed - chosen.length);
    appendLog(`Undo LED ${chosen.length}`);
    suggestNext();
    renderSegList();
    statusText.textContent='In progress';
  };

  finishBtn.onclick=()=>{ statusText.textContent='Finished'; };

  // --- Export ---
  function sanitizeName(n){
    return n.trim().replace(/[^A-Za-z0-9_]/g,'_').replace(/^[^A-Za-z_]+/,'').toUpperCase() || 'SEG';
  }

  exportCode.onclick=()=>{
    if(pins.length<2 || chosen.length===0){ alert('Please wire at least one LED first.'); return; }

    // PINS
    const pinsArr = pins.map(x=>x|0);

    // LED_MAP
    const ledMapLines = chosen.map(p=>`{${p.hiIdx}, ${p.loIdx}}`);

    // HEART indices
    const heart = [];
    chosen.forEach((c,i)=>{ if(c.kind==='HEART') heart.push(i); });

    // Enum index map
    const enumIndex = new Map();
    segments.forEach((s,idx)=>enumIndex.set(s.id, idx));

    // Children flattened
    const childrenFlat = [];
    const childStart = new Map();
    const childCount = new Map();
    segments.forEach(s=>{
      childStart.set(s.id, childrenFlat.length);
      (s.children||[]).forEach(cid=>childrenFlat.push(enumIndex.get(cid)));
      childCount.set(s.id, (s.children||[]).length);
    });

    // Segment arrays (oriented HEART -> out)
    const segNames = segments.map(s=>sanitizeName(s.name));
    const segArrays = segments.map((s,i)=>{
      const oriented = s.fromHeart ? s.leds.slice() : s.leds.slice().reverse();
      return `const uint8_t SEG_${segNames[i]}[] = { ${oriented.join(', ')} };`;
    });

    const segTableLines = segments.map((s,i)=>{
      const cs = childStart.get(s.id);
      const cc = childCount.get(s.id);
      return `  /* S_${segNames[i]} */ { SEG_${segNames[i]}, (uint8_t)sizeof(SEG_${segNames[i]}), ${cs}, ${cc} }`;
    });

    const roots = segments.filter(s=>!s.parentId).map(s=>'S_'+sanitizeName(s.name));

    const code =
`// ---- Generated by Charlieplex Wiring Helper ----
const uint8_t PINS[] = { ${pinsArr.join(', ')} };
const uint8_t N_PINS = sizeof(PINS);

struct Pair { uint8_t hi; uint8_t lo; };
const Pair LED_MAP[] = {
  ${ledMapLines.join(',\n  ')}
};
const uint8_t N_LEDS = sizeof(LED_MAP)/sizeof(LED_MAP[0]);

// HEART LEDs (indices refer to LED order above)
const uint8_t HEART[] = { ${heart.join(', ')} };
const uint8_t HEART_N = sizeof(HEART);

// ---- Branching segments (exported in pulse direction: HEART -> out) ----
${segArrays.join('\n')}

enum {
  ${segments.map(s=>'S_'+sanitizeName(s.name)).join(', ')},
  S_COUNT
};

// Child links (indices into enum)
const uint8_t CHILDREN[] = { ${childrenFlat.join(', ')} };

struct Segment { const uint8_t* leds; uint8_t len; uint8_t child_start; uint8_t child_count; };

const Segment SEGMENTS[S_COUNT] = {
${segTableLines.join(',\n')}
};

// Root segments (start after heartbeat)
const uint8_t ROOTS[] = { ${roots.join(', ')} };
const uint8_t ROOTS_N = sizeof(ROOTS);
`;

    codeOut.value = code;
  };

  copyCode.onclick=()=>{ navigator.clipboard?.writeText(codeOut.value); };

  // initial renders
  renderSegList();
})();
</script>
</body>
</html>
